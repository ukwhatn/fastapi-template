name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request_target:
    branches:
      - main
      - develop
  workflow_dispatch:

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Authorization check (only for pull_request_target)
  check-authorization:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event.pull_request.user.login == 'ukwhatn') ||
      (github.event.pull_request.user.login == 'dependabot[bot]')
    steps:
      - name: Authorized
        run: echo "✅ User authorized to run CI"

  # Code quality checks (parallel)
  lint:
    needs: check-authorization
    uses: ./.github/workflows/lint.yml

  type-check:
    needs: check-authorization
    uses: ./.github/workflows/type-check.yml

  security:
    needs: check-authorization
    uses: ./.github/workflows/security.yml

  # Tests (parallel)
  test:
    needs: check-authorization
    uses: ./.github/workflows/test.yml

  docker-test:
    needs: check-authorization
    uses: ./.github/workflows/docker-test.yml
    secrets: inherit

  # Summary job
  ci-success:
    runs-on: ubuntu-latest
    needs: [lint, type-check, security, test, docker-test]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.type-check.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.docker-test.result }}" != "success" ]; then
            echo "❌ One or more CI jobs failed"
            echo "Lint: ${{ needs.lint.result }}"
            echo "Type Check: ${{ needs.type-check.result }}"
            echo "Security: ${{ needs.security.result }}"
            echo "Test: ${{ needs.test.result }}"
            echo "Docker Test: ${{ needs.docker-test.result }}"
            exit 1
          fi
          echo "✅ All CI checks passed successfully!"
