name: Docker Integration Test

on:
  workflow_call:

jobs:
  docker-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR (for registry cache)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image with cache
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ghcr.io/${{ github.repository }}:latest
          cache-from: |
            type=gha,scope=docker-test-${{ github.head_ref || github.ref_name }}
            type=registry,ref=ghcr.io/${{ github.repository }}:buildcache
            type=gha,scope=docker-test-develop
            type=gha,scope=docker-test-main
          cache-to: type=gha,mode=max,scope=docker-test-${{ github.head_ref || github.ref_name }}

      - name: Setup environment
        run: |
          make env
          # „É≠„Éº„Ç´„É´DB‰ΩøÁî®Ë®≠ÂÆöÔºà„ÉÜ„Çπ„ÉàÁî®Ôºâ
          sed -i 's/POSTGRES_HOST=.*/POSTGRES_HOST=db/' .env
          # prodÁí∞Â¢ÉÁî®„ÅÆ.env.prod„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàêÔºàcompose.prod.yml„ÅßÂøÖË¶ÅÔºâ
          cp .env .env.prod

      - name: Start services with local DB
        run: make compose:up
        env:
          ENV: prod
          POSTGRES_HOST: db

      - name: Health check with timeout
        run: |
          timeout=60
          interval=5
          elapsed=0

          while [ $elapsed -lt $timeout ]; do
            status=$(ENV=prod POSTGRES_HOST=db make compose:ps:json | jq -rs 'map(.Health // "unknown") | join("\n")')

            if echo "$status" | grep -qiE "starting|unhealthy"; then
              echo "üïí Services starting... Elapsed: ${elapsed}s/${timeout}s"
              ENV=prod POSTGRES_HOST=db make compose:ps
              sleep $interval
              elapsed=$((elapsed + interval))
            else
              echo "‚úÖ All services healthy!"
              ENV=prod POSTGRES_HOST=db make compose:ps
              break
            fi
          done

          if [ $elapsed -ge $timeout ]; then
            echo "‚ùå Timeout: Services failed to start"
            ENV=prod POSTGRES_HOST=db make compose:ps
            ENV=prod POSTGRES_HOST=db make compose:logs
            exit 1
          fi

          echo "‚úÖ Health check passed!"

      - name: Clean up
        if: always()
        run: ENV=prod POSTGRES_HOST=db make compose:down
